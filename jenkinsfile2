pipeline {
    def gitcommit
    agent {
        docker { image 'node:16.13.1-alpine' }
    }
    stages {
         stage('Verificacion SCM') {
           checkout scm
           sh "git rev-parse --short HEAD > .git/commit-id"
           gitcommit = readFile('.git/commit-id').trim()
         }
         stage('test') {
           def contenedortest = docker.image('node:4.6')
           contenedortest.pull()
           contenedortest.inside {
             sh 'npm install --only=dev'
             sh 'npm test'
           }
         }                    
         stage('Docker Build & Push') {
           docker.withRegistry('https://registry.hub.docker.com', 'dockerhub') {
            def nuestraapp = docker.build("funknando/nodejsapp:${gitcommit}", ".")
            nuestraapp.push()
           }
         }
    }
}

